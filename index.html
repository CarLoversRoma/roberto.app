<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Link Organizer â€” Offline</title>
  <meta name="description" content="Organizza i tuoi link in locale (offline), con ricerca, tag, import/export.">
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--sub:#9ca3af;--acc:#22d3ee;--err:#ef4444;}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);color:var(--text);font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .container{max-width:1000px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 220deg at 50% 50%,#22d3ee, #06b6d4, #60a5fa,#22d3ee);box-shadow:0 0 24px #22d3ee44}
    h1{margin:0;font-size:22px;font-weight:700;letter-spacing:.2px}
    .bar{display:flex;gap:12px;flex-wrap:wrap}
    input[type="text"], input[type="url"], textarea, select{width:100%;background:var(--panel);border:1px solid #2b3547;color:var(--text);border-radius:12px;padding:10px 12px;outline:none}
    textarea{min-height:72px;resize:vertical}
    .card{background:rgba(17,24,39,.65);backdrop-filter:saturate(160%) blur(6px);border:1px solid #1f2a3d;border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;background:#1f2937;color:var(--text);}
    button.primary{background:linear-gradient(135deg,#22d3ee,#60a5fa);color:#07111b}
    button.ghost{background:transparent;border:1px dashed #2b3547}
    button.warn{background:linear-gradient(135deg,#ef4444,#f59e0b);color:#1a0c0c}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .item{position:relative;display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .url{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .muted{color:var(--sub);font-size:12px}
    .tag{display:inline-flex;background:#0b3140;border:1px solid #1e4a5c;color:#8be9ff;padding:.12rem .5rem;border-radius:999px;font-size:12px;margin-right:6px;margin-top:6px}
    .kbar{display:flex;gap:10px;align-items:center}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .spacer{flex:1}
    .hidden{display:none !important}
    .pill{background:#0e1a24;border:1px solid #1e2a3c;border-radius:999px;padding:6px 10px;font-size:13px;color:var(--sub)}
    .footer{margin-top:20px;color:var(--sub);font-size:12px;text-align:center}
    .editbox{display:grid;gap:8px;margin-top:8px}
    .danger{color:#ffb4b4}
    .highlight{outline:2px solid #22d3ee55}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Link Organizer <span class="pill">Offline</span></h1>
      </div>
      <div class="bar">
        <input id="q" type="text" placeholder="Cerca per titolo, summary, tag o dominioâ€¦" />
        <select id="sort">
          <option value="created_desc">PiÃ¹ recenti</option>
          <option value="created_asc">Meno recenti</option>
          <option value="title_asc">Titolo Aâ†’Z</option>
          <option value="title_desc">Titolo Zâ†’A</option>
        </select>
      </div>
    </header>

    <section class="card">
      <div class="grid">
        <div>
          <label>URL</label>
          <input id="url" type="url" placeholder="https://â€¦" />
        </div>
        <div>
          <label>Titolo</label>
          <input id="title" type="text" placeholder="Titolo del link" />
        </div>
      </div>
      <div style="margin-top:12px">
        <label>Summary / Note</label>
        <textarea id="summary" placeholder="Breve descrizione o appunti"></textarea>
      </div>
      <div class="grid" style="margin-top:12px">
        <div>
          <label>Tag (separate da virgola)</label>
          <input id="tags" type="text" placeholder="es. lavoro, ai, frontend" />
        </div>
        <div>
          <label>Azioni</label>
          <div class="actions">
            <button class="primary" id="saveBtn">Aggiungi</button>
            <button class="ghost" id="resetBtn">Pulisci</button>
            <span class="spacer"></span>
            <button id="exportBtn">Export JSON</button>
            <label class="inline">
              <input id="importFile" type="file" accept="application/json" class="hidden">
              <button id="importBtn">Import JSON</button>
            </label>
          </div>
        </div>
      </div>
      <div id="formError" class="muted danger" style="margin-top:8px"></div>
    </section>

    <section style="margin-top:16px" class="kbar">
      <span class="pill">âŒ˜/Ctrl + K = ricerca</span>
      <span class="pill">âŒ˜/Ctrl + S = salva</span>
      <span class="pill">âŒ˜/Ctrl + E = export</span>
      <span class="spacer"></span>
      <button id="clearAll" class="warn">Svuota tutto</button>
    </section>

    <section id="list" class="list" style="margin-top:16px"></section>
    <p class="footer">Tutto resta in locale (localStorage). Nessuna dipendenza esterna. Pronto per GitHub Pages.</p>
  </div>

<script>
(function(){
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const storeKey = "link_organizer_entries_v1";

  /** @type {{id:string,url:string,title:string,summary:string,tags:string[],created:number,updated:number}[]} */
  let data = load();

  function load(){
    try{
      const raw = localStorage.getItem(storeKey);
      return raw ? JSON.parse(raw) : [];
    }catch(e){ console.warn(e); return []; }
  }
  function persist(){ localStorage.setItem(storeKey, JSON.stringify(data)); }

  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

  function domain(u){
    try{ return new URL(u).hostname.replace(/^www\./,''); }catch{return "";}
  }

  function render(){
    const list = $("#list"); list.innerHTML = "";
    const q = $("#q").value.trim().toLowerCase();
    const sort = $("#sort").value;

    let rows = data.filter(x => {
      if(!q) return true;
      const hay = [x.title, x.summary, x.url, domain(x.url), ...x.tags].join(" ").toLowerCase();
      return hay.includes(q);
    });

    rows.sort((a,b)=>{
      if(sort==="created_desc") return b.created - a.created;
      if(sort==="created_asc") return a.created - b.created;
      if(sort==="title_asc") return a.title.localeCompare(b.title);
      if(sort==="title_desc") return b.title.localeCompare(a.title);
      return 0;
    });

    for(const row of rows){
      const el = document.createElement("div");
      el.className = "card item";
      el.innerHTML = `
        <div class="row">
          <div class="inline">
            <div style="width:28px;height:28px;border-radius:8px;background:#0e1a24;border:1px solid #1e2a3c;display:flex;align-items:center;justify-content:center;font-size:14px">ðŸ”—</div>
            <div>
              <div style="font-weight:700">${escapeHtml(row.title||"(senza titolo)")}</div>
              <div class="muted url">${escapeHtml(row.url)}</div>
            </div>
          </div>
          <div class="inline">
            <button data-act="open" data-id="${row.id}">Apri</button>
            <button data-act="copy" data-id="${row.id}">Copia URL</button>
            <button data-act="edit" data-id="${row.id}">Modifica</button>
            <button class="warn" data-act="del" data-id="${row.id}">Elimina</button>
          </div>
        </div>
        <div class="muted">${escapeHtml(row.summary||"")}</div>
        <div>${row.tags.map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join("")}</div>
        <div class="muted">${new Date(row.updated||row.created).toLocaleString()}</div>
      `;
      list.appendChild(el);

      // Edit box (hidden until edit)
      const editBox = document.createElement("div");
      editBox.className = "editbox hidden";
      editBox.innerHTML = `
        <input type="text" value="${escapeAttr(row.title)}" data-field="title">
        <input type="url" value="${escapeAttr(row.url)}" data-field="url">
        <textarea data-field="summary">${escapeHtml(row.summary||"")}</textarea>
        <input type="text" value="${escapeAttr(row.tags.join(", "))}" data-field="tags">
        <div class="actions">
          <button data-act="saveEdit" data-id="${row.id}" class="primary">Salva modifiche</button>
          <button data-act="cancelEdit" data-id="${row.id}">Annulla</button>
        </div>
      `;
      el.appendChild(editBox);
    }
  }

  function escapeHtml(s){
    return (s??"").toString().replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

  function resetForm(){
    $("#url").value = "";
    $("#title").value = "";
    $("#summary").value = "";
    $("#tags").value = "";
    $("#formError").textContent = "";
  }

  function validate(url, title){
    if(!url) return "URL obbligatorio";
    try{ new URL(url); }catch{return "URL non valido";}
    if(!title) return "Titolo obbligatorio";
    return "";
  }

  $("#saveBtn").addEventListener("click", ()=>{
    const url = $("#url").value.trim();
    const title = $("#title").value.trim();
    const summary = $("#summary").value.trim();
    const tags = $("#tags").value.split(",").map(s=>s.trim()).filter(Boolean);

    const err = validate(url,title);
    if(err){ $("#formError").textContent = err; return; }

    data.unshift({ id: uid(), url, title, summary, tags, created: Date.now(), updated: Date.now() });
    persist(); resetForm(); render();
  });

  $("#resetBtn").addEventListener("click", resetForm);

  $("#q").addEventListener("input", render);
  $("#sort").addEventListener("change", render);

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    if(!act) return;

    if(act==="open"){
      const row = data.find(x=>x.id===id);
      if(row) window.open(row.url, "_blank");
    }
    if(act==="copy"){
      const row = data.find(x=>x.id===id);
      if(row){ navigator.clipboard.writeText(row.url); btn.textContent="Copiato!"; setTimeout(()=>btn.textContent="Copia URL",1000); }
    }
    if(act==="edit"){
      const card = btn.closest(".item");
      const box = card.querySelector(".editbox");
      box.classList.toggle("hidden");
      card.classList.toggle("highlight");
    }
    if(act==="cancelEdit"){
      const card = btn.closest(".item");
      const box = card.querySelector(".editbox");
      box.classList.add("hidden");
      card.classList.remove("highlight");
    }
    if(act==="saveEdit"){
      const card = btn.closest(".item");
      const box = card.querySelector(".editbox");
      const inputs = box.querySelectorAll("[data-field]");
      const payload = {};
      inputs.forEach(inp=> payload[inp.dataset.field] = inp.value.trim());
      const tags = payload["tags"].split(",").map(s=>s.trim()).filter(Boolean);
      const url = payload["url"]; const title = payload["title"];
      const err = validate(url,title);
      if(err){ alert(err); return; }
      const idx = data.findIndex(x=>x.id===id);
      if(idx>=0){
        data[idx] = { ...data[idx], url, title, summary: payload["summary"], tags, updated: Date.now() };
        persist(); render();
      }
    }
    if(act==="del"){
      if(confirm("Eliminare questo link?")){
        data = data.filter(x=>x.id!==id);
        persist(); render();
      }
    }
  });

  $("#clearAll").addEventListener("click", ()=>{
    if(confirm("Sicuro di voler svuotare tutto?")){ data=[]; persist(); render(); }
  });

  $("#exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "link-organizer-export.json";
    a.click();
  });

  $("#importBtn").addEventListener("click", ()=> $("#importFile").click());
  $("#importFile").addEventListener("change", (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const arr = JSON.parse(reader.result);
        if(!Array.isArray(arr)) throw new Error("Formato non valido");
        // Merge, avoid id collisions
        const incoming = arr.map(x=>({ ...x, id: uid(), created: x.created||Date.now(), updated: Date.now()}));
        data = [...incoming, ...data];
        persist(); render();
      }catch(err){
        alert("Errore import: " + err.message);
      }
    };
    reader.readAsText(file);
  });

  // Keyboard shortcuts
  document.addEventListener("keydown", (e)=>{
    const cmd = e.ctrlKey || e.metaKey;
    if(cmd && e.key.toLowerCase()==="k"){ e.preventDefault(); $("#q").focus(); $("#q").select(); }
    if(cmd && e.key.toLowerCase()==="s"){ e.preventDefault(); $("#saveBtn").click(); }
    if(cmd && e.key.toLowerCase()==="e"){ e.preventDefault(); $("#exportBtn").click(); }
  });

  // If coming from legacy schema (Gemini-based), try to map if pasted JSON
  // (no-op here, but left as placeholder for future upgrades)

  render();
})();
</script>
</body>
</html>
