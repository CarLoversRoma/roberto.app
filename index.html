<!doctype html>
<html lang="it" data-theme="light">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Link Organizer ‚Äî Offline</title>
  <meta name="description" content="Organizza i tuoi link in locale (offline), con ricerca, tag, import/export.">
  <style>
    :root {
      /* Palette: Slate & Indigo (Premium SaaS) */
      --bg: #f8fafc;
      --panel: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --sub: #64748b;
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --primary-sub: #eef2ff;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;

      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

      --radius: 12px;
      --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --panel: #1e293b;
      --border: #334155;
      --text: #f1f5f9;
      --sub: #94a3b8;
      --primary: #6366f1;
      --primary-hover: #818cf8;
      --primary-sub: #1e1b4b;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 40px 20px;
    }

    .container-fluid {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 32px;
    }

    /* === Top Section (Dashboard Header) === */
    .top-section {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      margin-bottom: 32px;
      box-shadow: var(--shadow-sm);
    }

    [data-theme="dark"] .top-section {
      background: #172030;
    }

    /* === Header === */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      gap: 24px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), #818cf8);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
      box-shadow: var(--shadow);
    }

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    h1 span {
      font-size: 12px;
      color: var(--sub);
      font-weight: 500;
    }

    .bar {
      display: flex;
      gap: 12px;
      flex: 1;
      justify-content: flex-end;
      max-width: 600px;
    }

    input,
    select,
    textarea,
    button {
      font-family: inherit;
      font-size: 14px;
    }

    /* === Forms & Inputs === */
    input[type="text"],
    input[type="url"],
    textarea,
    select {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 10px 14px;
      width: 100%;
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-sub);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--sub);
    }

    /* === Buttons === */
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 500;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      gap: 8px;
      box-shadow: var(--shadow-sm);
      line-height: 1;
    }

    button:hover {
      background: var(--bg);
      border-color: var(--sub);
    }

    button.primary {
      background: var(--primary);
      color: white;
      border-color: transparent;
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }

    button.primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    button.danger {
      color: var(--danger);
      border-color: var(--border);
    }

    button.danger:hover {
      background: #fee2e2;
      border-color: var(--danger);
    }

    button.ghost {
      background: transparent;
      border: none;
      box-shadow: none;
      color: var(--sub);
    }

    button.ghost:hover {
      background: var(--bg);
      color: var(--text);
    }

    /* === Cards & Containers === */
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .grid-form {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {

      .grid-form,
      .grid-2 {
        grid-template-columns: 1fr;
      }

      .bar {
        display: none;
        /* Hide search bar on mobile for now or stack it */
      }
    }

    /* === Link List === */
    .list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
      margin-top: 32px;
    }

    .item {
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .item-header {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .item-icon {
      width: 36px;
      height: 36px;
      background: var(--bg);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--sub);
      flex-shrink: 0;
    }

    .item-content {
      flex: 1;
      min-width: 0;
    }

    .item-title {
      font-weight: 600;
      color: var(--text);
      font-size: 15px;
      margin-bottom: 2px;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .item-url {
      color: var(--primary);
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      text-decoration: none;
    }

    .item-desc {
      font-size: 13px;
      color: var(--sub);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.5;
    }

    .item-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tag {
      font-size: 11px;
      background: var(--bg);
      color: var(--sub);
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
      border: 1px solid var(--border);
    }

    .item-actions {
      display: flex;
      gap: 4px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .item:hover .item-actions {
      opacity: 1;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      padding: 0;
      font-size: 14px;
      border: none;
      background: transparent;
      box-shadow: none;
      color: var(--sub);
    }

    .btn-icon:hover {
      color: var(--primary);
      background: var(--bg);
    }

    .btn-icon.del:hover {
      color: var(--danger);
    }

    /* === Edit Box === */
    .editbox {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      display: grid;
      gap: 12px;
    }

    /* === Wizard / Cloud === */
    .cloud-services {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .cloud-services summary {
      padding: 16px 20px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cloud-services summary:hover {
      background: var(--bg);
    }

    .cloud-content {
      padding: 20px;
      border-top: 1px solid var(--border);
    }

    .wizard-container {
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
    }

    .wizard-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
    }

    /* === Wizard Steps === */
    .wizard-step {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }

    .wizard-step.active {
      display: block;
    }

    .wizard-steps {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 32px;
    }

    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s;
    }

    .step-dot.active {
      background: var(--primary);
      transform: scale(1.2);
    }

    .step-dot.completed {
      background: var(--success);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>

  <!-- Favicon (fallback JPG) -->
  <link rel="icon" type="image/jpeg" href="favicon.jpg">

  <!-- Google Identity Services (OAuth2) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API Client -->
  <script src="https://apis.google.com/js/api.js"></script>



</head>

<body>
  <div class="top-section">
    <div class="container-fluid">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <h1>Link Organizer
            <span id="syncBadge" class="pill local">üì° Locale</span>
            <span id="linkCount" class="pill" style="font-size:11px">0 link</span>
          </h1>
        </div>
        <div class="bar">
          <input id="q" type="text" placeholder="Cerca per titolo, summary, tag o dominio‚Ä¶" />
          <select id="sort" aria-label="Ordinamento">
            <option value="created_desc">Pi√π recenti</option>
            <option value="created_asc">Meno recenti</option>
            <option value="title_asc">Titolo A‚ÜíZ</option>
            <option value="title_desc">Titolo Z‚ÜíA</option>
          </select>
          <button id="themeBtn" title="Cambia tema">‚òÄÔ∏è/üåô</button>
        </div>
      </header>

      <section class="input-panel">
        <div class="grid-2">
          <div>
            <label for="url">URL</label>
            <input id="url" type="url" placeholder="https://‚Ä¶" />
          </div>
          <div>
            <label for="title">Titolo</label>
            <input id="title" type="text" placeholder="Titolo del link" />
          </div>
        </div>
        <div style="margin-top:20px">
          <label for="summary">Summary / Note</label>
          <textarea id="summary" placeholder="Breve descrizione o appunti"></textarea>
        </div>
        <div class="grid-form" style="margin-top:20px">
          <div>
            <label for="tags">Tag (separate da virgola)</label>
            <input id="tags" type="text" placeholder="es. lavoro, ai, frontend" />
          </div>
          <div>
            <label>Azioni</label>
            <div class="actions">
              <button class="primary" id="saveBtn">Aggiungi</button>
              <button class="ghost" id="resetBtn">Pulisci</button>
              <span style="flex:1"></span>
              <button id="exportBtn">Export JSON</button>
              <label style="display:inline-flex;gap:8px;align-items:center">
                <input id="importFile" type="file" accept="application/json" style="display:none">
                <button id="importBtn">Import JSON</button>
              </label>
            </div>
          </div>
        </div>
        <div id="formError" class="muted" style="margin-top:var(--space-2);color:#dc2626"></div>
      </section>
    </div>
  </div>

  <div class="container main-content-area">
    <section
      style="margin-top:var(--space-3);display:flex;gap:var(--space-2);align-items:center;margin-bottom:var(--space-4)">
      <span class="pill">‚åò/Ctrl + K</span>
      <span class="pill">‚åò/Ctrl + S</span>
      <span class="pill">‚åò/Ctrl + E</span>
      <span style="flex:1"></span>
      <button id="clearAll" class="warn">Svuota tutto</button>
    </section>

    <!-- Cloud Services Section -->
    <details class="card cloud-services" style="margin-top:var(--space-3)">
      <summary>
        <h3>‚òÅÔ∏è Cloud Services</h3>
        <span id="cloudStatus" class="muted">Non configurato</span>
      </summary>

      <!-- Google Drive Panel (Default Active) -->
      <div id="gdrive-panel" class="tab-panel active" style="display:block">


        <!-- Connected State -->
        <div id="gdriveConnected" style="display:none">
          <div
            style="display:flex;align-items:center;gap:var(--space-2);padding:var(--space-2);background:var(--bg);border-radius:var(--radius-sm);margin-bottom:var(--space-3)">
            <span style="font-size:20px">‚úì</span>
            <div style="flex:1">
              <div style="font-weight:600">Connesso a Google Drive</div>
              <div id="gdriveUserEmail" class="muted" style="font-size:12px"></div>
            </div>
          </div>
          <div class="actions">
            <button id="gdriveDisconnect">üîå Disconnetti</button>
            <button id="gdriveRestore">üì• Ripristina Backup</button>
            <button id="gdriveManualBackup" class="ghost">üíæ Backup Manuale</button>
          </div>
        </div>

        <!-- Wizard State -->
        <div id="gdriveDisconnected" class="wizard-container">
          <!-- Step 1: Config (Was Step 2) -->
          <div class="wizard-step active" data-step="1">
            <div class="wizard-header">
              <h3>üì¶ Google Drive Backup</h3>
              <p class="muted">Configura il backup automatico sul tuo Drive.</p>
            </div>
            <div style="display:grid;gap:var(--space-2)">
              <div
                style="background:var(--btn);padding:var(--space-2);border-radius:var(--radius-sm);font-size:13px;line-height:1.5">
                <strong>Come ottenere il Client ID (Gratis):</strong>
                <ol style="margin:8px 0 8px 20px;padding:0">
                  <li>Vai su <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
                      style="color:var(--acc)">Google Cloud Console</a>.</li>
                  <li>Crea un progetto e clicca "Crea Credenziali" ‚Üí "ID client OAuth".</li>
                  <li>Scegli "Applicazione Web".</li>
                  <li>In <strong>Origini JavaScript autorizzate</strong> aggiungi:
                    <ul style="margin:4px 0 4px 16px;padding:0;list-style-type:disc">
                      <li><code
                          style="background:var(--bg);padding:2px 4px;border-radius:4px">http://localhost:8000</code>
                      </li>
                      <li><code style="background:var(--bg);padding:2px 4px;border-radius:4px"
                          id="currentOriginCode"></code> (URL Attuale)</li>
                    </ul>
                  </li>
                  <script>document.getElementById("currentOriginCode").textContent = window.location.origin;</script>
                  <li>Copia il <strong>Client ID</strong> qui sotto.</li>
                </ol>
              </div>
              <label for="gdriveClientId" style="margin-top:var(--space-2)">Google Cloud CLIENT_ID</label>
              <input id="gdriveClientId" type="text" placeholder="123456789012-xxxxx.apps.googleusercontent.com" />
              <div id="clientIdFeedback" class="muted" style="font-size:12px"></div>
            </div>
            <div class="wizard-actions">
              <span></span>
              <button class="primary" onclick="window.Wizard.validateAndNext('gdrive')">Verifica e Continua ‚Üí</button>
            </div>
          </div>

          <!-- Step 2: Auth (Was Step 3) -->
          <div class="wizard-step" data-step="2">
            <div class="wizard-header">
              <h3>üîê Autorizzazione</h3>
              <p class="muted">Autorizza l'applicazione ad accedere a Drive.</p>
            </div>
            <div style="text-align:center;margin:2em 0">
              <p>Si aprir√† un popup di Google per il login.</p>
            </div>
            <div class="wizard-actions">
              <button class="ghost" onclick="window.Wizard.prev('gdrive')">‚Üê Indietro</button>
              <button id="gdriveConnect" class="primary">Autorizza con Google üîó</button>
            </div>
          </div>

          <!-- Dots -->
          <div class="wizard-steps" id="gdrive-dots">
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
          </div>
        </div>
      </div>
      <!-- Connected -->
      <div id="gdriveConnected" style="display:none">
        <div
          style="display:flex;align-items:center;gap:var(--space-2);padding:var(--space-2);background:var(--bg);border-radius:var(--radius-sm);margin-bottom:var(--space-3)">
          <span style="font-size:20px">‚úì</span>
          <div style="flex:1">
            <div style="font-weight:600">Connesso a Google Drive</div>
            <div id="gdriveUserEmail" class="muted" style="font-size:12px"></div>
          </div>
        </div>
        <div class="actions">
          <button id="gdriveDisconnect">üîå Disconnetti</button>
          <button id="gdriveRestore">üì• Ripristina Backup</button>
          <button id="gdriveManualBackup" class="ghost">üíæ Backup Manuale</button>
        </div>
      </div>
  </div>
  </details>


  <section id="list" class="list" style="margin-top:var(--space-3)"></section>
  <p class="footer">Tutto resta in locale (localStorage). Nessuna dipendenza esterna. Pronto per GitHub Pages.</p>
  </div>

  <script type="module">
    (function () {
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      const storeKey = "link_organizer_entries_v1";
      const themeKey = "link_organizer_theme";

      function applyTheme(t) {
        document.documentElement.setAttribute("data-theme", t);
        localStorage.setItem(themeKey, t);
        const btn = $("#themeBtn");
        if (btn) { btn.textContent = (t === "dark" ? "üåô" : "‚òÄÔ∏è") + "/" + (t === "dark" ? "‚òÄÔ∏è" : "üåô"); }
      }
      (function initTheme() {
        const saved = localStorage.getItem(themeKey);
        if (saved === "dark" || saved === "light") { applyTheme(saved); return; }
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(prefersDark ? "dark" : "light");
      })();
      $("#themeBtn").addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme") || "light";
        applyTheme(current === "dark" ? "light" : "dark");
      });

      // =====================================================
      // HELPER: ROBUST CONFIG PARSER
      // =====================================================
      function parseConfig(input) {
        let configStr = input.trim();
        // Try to clean up JS object syntax if pasted directly from console
        // Remove "const firebaseConfig =" part and trailing semicolon
        configStr = configStr.replace(/^(const|var|let)\s+\w+\s*=\s*/, "").replace(/;$/, "");

        // Remove comments
        configStr = configStr.replace(/\/\/.*$/gm, "").replace(/\/\*[\s\S]*?\*\//g, "");

        try {
          // Try strict JSON parse first
          return JSON.parse(configStr);
        } catch (jsonErr) {
          // Fallback: Try to eval as JS object (for unquoted keys)
          try {
            return new Function("return " + configStr)();
          } catch (evalErr) {
            throw new Error("Formato non riconosciuto. Assicurati di copiare l'oggetto {...}");
          }
        }
      }

      // =====================================================
      // WIZARD HELPER CLASS
      // =====================================================
      window.Wizard = {
        state: {
          gdrive: { step: 1, total: 2 }
        },

        goTo(service, step) {
          const container = document.querySelector(`#${service}Disconnected`);
          if (!container) return;

          // Hide all steps
          container.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));

          // Show target step
          const target = container.querySelector(`.wizard-step[data-step="${step}"]`);
          if (target) target.classList.add('active');

          // Update dots
          const dots = container.querySelectorAll('.step-dot');
          dots.forEach((dot, idx) => {
            if (idx + 1 === step) dot.className = "step-dot active";
            else if (idx + 1 < step) dot.className = "step-dot completed";
            else dot.className = "step-dot";
          });

          this.state[service].step = step;
        },

        next(service) {
          this.goTo(service, this.state[service].step + 1);
        },

        prev(service) {
          // For GDrive, prevent going back from step 1
          if (service === 'gdrive' && this.state.gdrive.step === 1) return;
          this.goTo(service, this.state[service].step - 1);
        },

        validateAndNext(service) {
          if (service === 'firebase') {
            try {
              const cfg = parseConfig($("#firebaseConfig").value);

              if (!cfg || !cfg.apiKey || !cfg.projectId) {
                throw new Error("Mancano campi obbligatori (apiKey, projectId, etc)");
              }

              this.next(service);
            } catch (e) {
              alert("Configurazione non valida: " + e.message + "\n\nSuggerimento: Copia l'intero oggetto 'const firebaseConfig = { ... }' dalla console di Firebase.");
            }
          }
          if (service === 'gdrive') {
            // Always custom mode now
            const cid = $("#gdriveClientId").value.trim();
            if (!cid) { alert("Inserisci un Client ID"); return; }
            // Basic regex check
            if (!/^\d{12,}-[a-zA-Z0-9_-]{10,}\.apps\.googleusercontent\.com$/.test(cid)) {
              alert("Formato Client ID non valido"); return;
            }
            this.next(service);
          }
        },

        selectDriveMode(mode) {
          this.state.gdrive.mode = mode;
          if (mode === 'preset') {
            this.goTo('gdrive', 3);
          } else {
            this.goTo('gdrive', 2);
          }
        }
      };


      // =====================================================
      // TAB SWITCHING LOGIC
      // =====================================================

      // =====================================================
      // TAB SWITCHING LOGIC
      // =====================================================
      function initTabSwitching() {
        const tabBtns = $$('.tab-btn');
        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const targetTab = btn.dataset.tab;

            // Update active button
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update active panel
            $$('.tab-panel').forEach(panel => panel.classList.remove('active'));
            const targetPanel = $(`#${targetTab}-panel`);
            if (targetPanel) targetPanel.classList.add('active');
          });
        });
      }

      // Initialize tab switching
      initTabSwitching();


      let data = load();
      function load() {
        try {
          const raw = localStorage.getItem(storeKey);
          return raw ? JSON.parse(raw) : [];
        } catch (e) { console.warn(e); return []; }
      }
      function persist() { localStorage.setItem(storeKey, JSON.stringify(data)); }
      function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
      function domain(u) {
        try { return new URL(u).hostname.replace(/^www\./, ''); } catch { return ""; }
      }

      function render() {
        const list = $("#list"); list.innerHTML = "";
        const q = $("#q").value.trim().toLowerCase();
        const sort = $("#sort").value;

        // Update counter
        $("#linkCount").textContent = data.length + (data.length === 1 ? " link" : " link");

        let rows = data.filter(x => {
          if (!q) return true;
          const hay = [x.title, x.summary, x.url, domain(x.url), ...x.tags].join(" ").toLowerCase();
          return hay.includes(q);
        });

        rows.sort((a, b) => {
          if (sort === "created_desc") return b.created - a.created;
          if (sort === "created_asc") return a.created - b.created;
          if (sort === "title_asc") return a.title.localeCompare(b.title);
          if (sort === "title_desc") return b.title.localeCompare(a.title);
          return 0;
        });

        for (const row of rows) {
          const el = document.createElement("div");
          el.className = "card item";
          el.innerHTML = `
            <div class="item-header">
              <div class="item-icon">üîó</div>
              <div class="item-content">
                <div class="item-title" title="${escapeAttr(row.title)}">${escapeHtml(row.title || "(senza titolo)")}</div>
                <a href="${escapeAttr(row.url)}" target="_blank" class="item-url" title="${escapeAttr(row.url)}">${escapeHtml(row.url)}</a>
              </div>
            </div>
            
            <div class="item-desc" title="${escapeAttr(row.summary)}">${escapeHtml(row.summary || "")}</div>
            
            <div class="item-footer">
              <div class="tags">
                ${row.tags.map(t => `<span class="tag">#${escapeHtml(t)}</span>`).join("")}
              </div>
              <div class="item-actions">
                <button class="btn-icon" data-act="copy" data-id="${row.id}" title="Copia"><span style="filter:grayscale(1)">üìã</span></button>
                <button class="btn-icon" data-act="edit" data-id="${row.id}" title="Modifica">‚úèÔ∏è</button>
                <button class="btn-icon del" data-act="del" data-id="${row.id}" title="Elimina">üóëÔ∏è</button>
              </div>
            </div>
          `;
          list.appendChild(el);

          const editBox = document.createElement("div");
          editBox.className = "editbox";
          editBox.style.display = "none";
          editBox.innerHTML = `
            <input type="text" value="${escapeAttr(row.title)}" data-field="title" aria-label="Titolo" placeholder="Titolo">
            <input type="url" value="${escapeAttr(row.url)}" data-field="url" aria-label="URL" placeholder="URL">
            <textarea data-field="summary" aria-label="Summary" placeholder="Descrizione">${escapeHtml(row.summary || "")}</textarea>
            <input type="text" value="${escapeAttr(row.tags.join(", "))}" data-field="tags" aria-label="Tag" placeholder="Tag (separati da virgola)">
            <div style="display:flex;gap:10px;justify-content:flex-end">
              <button data-act="cancelEdit" data-id="${row.id}" class="ghost">Annulla</button>
              <button data-act="saveEdit" data-id="${row.id}" class="primary">Salva Modifiche</button>
            </div>
          `;
          el.appendChild(editBox);
        }
      }

      function escapeHtml(s) {
        return (s ?? "").toString().replace(/[&<>]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c]));
      }
      function escapeAttr(s) { return escapeHtml(s).replace(/"/g, "&quot;"); }

      function resetForm() {
        $("#url").value = "";
        $("#title").value = "";
        $("#summary").value = "";
        $("#tags").value = "";
        $("#formError").textContent = "";
      }

      function validate(url, title) {
        if (!url) return "URL obbligatorio";
        try { new URL(url); } catch { return "URL non valido"; }
        if (!title) return "Titolo obbligatorio";
        return "";
      }

      const Actions = {
        async add(item) {
          data.unshift(item);
          persist();
          render();

          // Auto-backup to Google Drive
          if (GoogleDriveBackup.isConnected()) {
            // Run silently (no await blocking UI, catch errors)
            GoogleDriveBackup.uploadBackup(data).catch(console.error);
          }
        },
        async update(id, updates) {
          const idx = data.findIndex(x => x.id === id);
          if (idx === -1) return;
          const newItem = { ...data[idx], ...updates, updated: Date.now() };

          data[idx] = newItem;
          persist();
          render();

          // Auto-backup
          if (GoogleDriveBackup.isConnected()) {
            GoogleDriveBackup.uploadBackup(data).catch(console.error);
          }
        },
        async delete(id) {
          if (!confirm("Eliminare questo link?")) return;
          data = data.filter(x => x.id !== id);
          persist();
          render();

          // Auto-backup
          if (GoogleDriveBackup.isConnected()) {
            GoogleDriveBackup.uploadBackup(data).catch(console.error);
          }
        },
        async clearAll() {
          if (confirm("Sicuro di voler svuotare tutto?")) {
            data = [];
            persist();
            render();

            // Auto-backup
            if (GoogleDriveBackup.isConnected()) {
              GoogleDriveBackup.uploadBackup(data).catch(console.error);
            }
          }
        }
      };

      $("#saveBtn").addEventListener("click", () => {
        const url = $("#url").value.trim();
        const title = $("#title").value.trim();
        const summary = $("#summary").value.trim();
        const tags = $("#tags").value.split(",").map(s => s.trim()).filter(Boolean);

        const err = validate(url, title);
        if (err) { $("#formError").textContent = err; return; }

        const item = { id: uid(), url, title, summary, tags, created: Date.now(), updated: Date.now() };
        Actions.add(item);
        resetForm();
      });

      $("#resetBtn").addEventListener("click", resetForm);

      $("#q").addEventListener("input", render);
      $("#sort").addEventListener("change", render);

      document.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const act = btn.dataset.act;
        const id = btn.dataset.id;
        if (!act) return;

        if (act === "open") {
          const row = data.find(x => x.id === id);
          if (row) window.open(row.url, "_blank");
        }
        if (act === "copy") {
          const row = data.find(x => x.id === id);
          if (row) {
            navigator.clipboard.writeText(row.url);
            const original = btn.innerHTML;
            btn.innerHTML = `<span style="color:#10b981">‚úì</span>`;
            setTimeout(() => btn.innerHTML = original, 1500);
          }
        }
        if (act === "edit") {
          const card = btn.closest(".item");
          const box = card.querySelector(".editbox");
          const now = getComputedStyle(box).display === "none";
          box.style.display = now ? "grid" : "none";
        }
        if (act === "cancelEdit") {
          const card = btn.closest(".item");
          const box = card.querySelector(".editbox");
          box.style.display = "none";
        }
        if (act === "saveEdit") {
          const card = btn.closest(".item");
          const box = card.querySelector(".editbox");
          const inputs = box.querySelectorAll("[data-field]");
          const payload = {};
          inputs.forEach(inp => payload[inp.dataset.field] = inp.value.trim());
          const tags = payload["tags"].split(",").map(s => s.trim()).filter(Boolean);
          const url = payload["url"]; const title = payload["title"];
          const err = validate(url, title);
          if (err) { alert(err); return; }
          const idx = data.findIndex(x => x.id === id);
          if (idx >= 0) {
            Actions.update(id, { url, title, summary: payload["summary"], tags });
          }
        }
        if (act === "del") {
          Actions.delete(id);
        }
      });

      $("#clearAll").addEventListener("click", () => Actions.clearAll());

      $("#exportBtn").addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "link-organizer-export.json";
        a.click();
      });

      $("#importBtn").addEventListener("click", () => $("#importFile").click());
      $("#importFile").addEventListener("change", (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const arr = JSON.parse(reader.result);
            if (!Array.isArray(arr)) throw new Error("Formato non valido");
            const incoming = arr.map(x => ({ ...x, id: uid(), created: x.created || Date.now(), updated: Date.now() }));
            data = [...incoming, ...data];
            persist(); render();
          } catch (err) {
            alert("Errore import: " + err.message);
          }
        };
        reader.readAsText(file);
      });

      document.addEventListener("keydown", (e) => {
        const cmd = e.ctrlKey || e.metaKey;
        if (cmd && e.key.toLowerCase() === "k") { e.preventDefault(); $("#q").focus(); $("#q").select(); }
        if (cmd && e.key.toLowerCase() === "s") { e.preventDefault(); $("#saveBtn").click(); }
        if (cmd && e.key.toLowerCase() === "e") { e.preventDefault(); $("#exportBtn").click(); }
      });





      // =====================================================
      // GOOGLE DRIVE AUTO-BACKUP MODULE
      // =====================================================
      const GoogleDriveBackup = (() => {
        // Default CLIENT_ID generato da Google Identity Services
        // Questo √® un CLIENT_ID pubblico sicuro da usare per app client-side
        const GDRIVE_CLIENT_ID_KEY = "gdrive_client_id";
        const GDRIVE_TOKEN_KEY = "gdrive_access_token";
        const GDRIVE_EMAIL_KEY = "gdrive_user_email";
        // REMOVED: GDRIVE_USE_PRESET_KEY
        const GDRIVE_SETUP_COMPLETE_KEY = "gdrive_setup_complete";
        const MAX_BACKUPS = 10;
        const BACKUP_PREFIX = "link-organizer-backup-";

        let gapi_loaded = false;
        let tokenClient = null;

        // Initialize Google API
        function initGoogleAPI() {
          return new Promise((resolve) => {
            if (gapi_loaded) { resolve(); return; }
            if (typeof gapi === 'undefined') {
              console.error("Google API not loaded");
              resolve();
              return;
            }
            gapi.load('client', async () => {
              await gapi.client.init({});
              await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
              gapi_loaded = true;
              resolve();
            });
          });
        }

        // Validate CLIENT_ID format
        function validateClientId(clientId) {
          if (!clientId) return false;
          // Format: 123456789012-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com
          // Google CLIENT_IDs have: 12+ digits, dash, alphanumeric string (variable length), .apps.googleusercontent.com
          const pattern = /^\d{12,}-[a-zA-Z0-9_-]{10,}\.apps\.googleusercontent\.com$/;
          return pattern.test(clientId);
        }

        // Check if setup is complete
        function isSetupComplete() {
          return localStorage.getItem(GDRIVE_SETUP_COMPLETE_KEY) === "true";
        }

        // Mark setup as complete
        function markSetupComplete() {
          localStorage.setItem(GDRIVE_SETUP_COMPLETE_KEY, "true");
        }

        // Get stored CLIENT_ID
        function getClientId() {
          return localStorage.getItem(GDRIVE_CLIENT_ID_KEY) || ($("#gdriveClientId") ? $("#gdriveClientId").value.trim() : "");
        }

        // Save CLIENT_ID
        function saveClientId(clientId) {
          localStorage.setItem(GDRIVE_CLIENT_ID_KEY, clientId);
          if ($("#gdriveClientId")) {
            $("#gdriveClientId").value = clientId;
          }
          markSetupComplete();
        }

        // Check if connected
        function isConnected() {
          const token = localStorage.getItem(GDRIVE_TOKEN_KEY);
          return !!token;
        }

        // Get access token
        function getAccessToken() {
          return localStorage.getItem(GDRIVE_TOKEN_KEY);
        }

        // Save token and user info
        function saveCredentials(token, email) {
          localStorage.setItem(GDRIVE_TOKEN_KEY, token);
          localStorage.setItem(GDRIVE_EMAIL_KEY, email);
        }

        // Clear credentials
        function clearCredentials() {
          localStorage.removeItem(GDRIVE_TOKEN_KEY);
          localStorage.removeItem(GDRIVE_EMAIL_KEY);
        }

        // Update UI based on connection status
        function updateUI() {
          const connected = isConnected();
          const email = localStorage.getItem(GDRIVE_EMAIL_KEY);

          // Show appropriate mode based on state
          if (connected) {
            $("#gdriveDisconnected").style.display = "none";
            $("#gdriveConnected").style.display = "block";
            if (email) $("#gdriveUserEmail").textContent = email;
          } else {
            $("#gdriveConnected").style.display = "none";
            $("#gdriveDisconnected").style.display = "block";
            // Reset wizard to step 1
            window.Wizard.goTo('gdrive', 1);
          }
        }

        // Update CLIENT_ID validation feedback
        function updateClientIdValidation(clientId) {
          const validation = $("#clientIdFeedback");
          if (!validation) return;

          if (!clientId) {
            validation.textContent = "";
            return;
          }

          const isValid = validateClientId(clientId);
          if (isValid) {
            validation.innerHTML = "<span style='color:#10b981'>‚úì Valido</span>";
          } else {
            validation.innerHTML = "<span style='color:#ef4444'>‚úó Formato non valido</span>";
          }
        }

        // OAuth2 authentication
        async function authenticate() {
          if (window.location.protocol === 'file:') {
            alert("‚ö†Ô∏è ATTENZIONE: Google Drive NON funziona aprendo il file direttamente (file://).\n\nDevi avviare un server locale:\n1. Esegui il file 'start_server.bat'\n2. Apri il browser su http://localhost:8000");
            return false;
          }
          // Always use custom client ID
          const cid = $("#gdriveClientId") ? $("#gdriveClientId").value.trim() : null;
          if (cid) saveClientId(cid);

          const clientId = getClientId();

          // DEBUG: Verify Client ID
          console.log("Authenticating with Client ID:", clientId);
          if (clientId.includes("1068770927838")) {
            alert("‚ö†Ô∏è ATTENZIONE: Stai usando ancora il vecchio ID demo disattivo. Inserisci il TUO ID.");
            localStorage.removeItem(GDRIVE_CLIENT_ID_KEY);
            return false;
          }

          // Validate CLIENT_ID format
          if (!validateClientId(clientId)) {
            showErrorDialog(
              "‚ùå CLIENT_ID non valido",
              "Il formato del CLIENT_ID non √® corretto.",
              "Assicurati di aver copiato l'intero CLIENT_ID dalla Google Cloud Console. Deve essere nel formato: 123456789012-xxxxx.apps.googleusercontent.com"
            );
            if ($("#gdriveClientId")) $("#gdriveClientId").focus();
            return false;
          }

          if (!clientId) {
            alert("Inserisci prima il CLIENT_ID di Google Cloud");
            if ($("#gdriveClientId")) $("#gdriveClientId").focus();
            return false;
          }

          saveClientId(clientId);
          await initGoogleAPI();

          return new Promise((resolve) => {
            if (typeof google === 'undefined' || !google.accounts) {
              alert("Google Identity Services non caricato. Ricarica la pagina.");
              resolve(false);
              return;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: clientId,
              scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email',
              callback: async (response) => {
                if (response.error) {
                  console.error("Auth error:", response);
                  handleAuthError(response.error, response.error_description);
                  resolve(false);
                  return;
                }

                gapi.client.setToken({ access_token: response.access_token });

                // Get user email
                try {
                  const userInfo = await gapi.client.request({
                    path: 'https://www.googleapis.com/oauth2/v2/userinfo'
                  });
                  const email = userInfo.result.email;
                  saveCredentials(response.access_token, email);
                  updateUI();
                  showSuccessDialog(
                    "‚úì Connesso a Google Drive!",
                    `Account: ${email}`,
                    "Backup automatici attivati! Ogni volta che chiudi l'app verr√† creato un backup su Google Drive (ultimi 10 backup conservati)."
                  );
                  resolve(true);
                } catch (err) {
                  console.error("Error getting user info:", err);
                  saveCredentials(response.access_token, "utente");
                  updateUI();
                  resolve(true);
                }
              },
            });

            tokenClient.requestAccessToken({ prompt: 'consent' });
          });
        }

        // Handle authentication errors
        function handleAuthError(error, description) {
          const errorHandlers = {
            'redirect_uri_mismatch': {
              title: "‚ùå Errore: URI di reindirizzamento",
              message: "Gli URI autorizzati nella Google Cloud Console non corrispondono.",
              action: "1. Vai su https://console.cloud.google.com/apis/credentials\n2. Modifica il tuo Client OAuth 2.0\n3. Aggiungi questi URI alle 'Origini JavaScript autorizzate':\n   ‚Ä¢ http://localhost:8000\n   ‚Ä¢ http://127.0.0.1:8000\n4. Salva e aspetta 2-3 minuti"
            },
            'invalid_client': {
              title: "‚ùå CLIENT_ID non valido",
              message: "Il CLIENT_ID inserito non √® corretto o non esiste.",
              action: "1. Verifica di aver copiato l'intero CLIENT_ID\n2. Assicurati di usare un 'ID client OAuth 2.0' (NON API Key)\n3. Il formato deve essere: 123456789012-xxxxx.apps.googleusercontent.com"
            },
            'access_denied': {
              title: "‚ö†Ô∏è Accesso negato",
              message: "Hai negato l'autorizzazione a Google Drive.",
              action: "Per usare i backup automatici, devi autorizzare l'accesso a Google Drive. Riprova e clicca 'Consenti' nel popup."
            },
            'popup_closed_by_user': {
              title: "‚ÑπÔ∏è Popup chiuso",
              message: "Hai chiuso il popup di autorizzazione.",
              action: "Riprova e completa l'autorizzazione nel popup di Google."
            }
          };

          const handler = errorHandlers[error] || {
            title: "‚ùå Errore autenticazione",
            message: `Errore: ${error}`,
            action: description || "Riprova pi√π tardi o usa la modalit√† avanzata con il tuo CLIENT_ID personalizzato."
          };

          showErrorDialog(handler.title, handler.message, handler.action);
        }

        // Show error dialog
        function showErrorDialog(title, message, action) {
          const formattedAction = action.replace(/\n/g, '\n');
          alert(`${title}\n\n${message}\n\n${formattedAction}`);
        }

        // Show success dialog
        function showSuccessDialog(title, message, details) {
          alert(`${title}\n\n${message}\n\n${details}`);
        }

        // Disconnect
        function disconnect() {
          if (confirm("Disconnettere Google Drive? I backup automatici verranno disabilitati.")) {
            const token = getAccessToken();
            if (token && typeof google !== 'undefined' && google.accounts) {
              google.accounts.oauth2.revoke(token, () => {
                console.log("Token revoked");
              });
            }
            clearCredentials();
            // REMOVED: localStorage.removeItem(GDRIVE_USE_PRESET_KEY);
            updateUI();
          }
        }

        // Manual backup
        async function manualBackup() {
          if (!isConnected()) {
            alert("Devi essere connesso a Google Drive per creare un backup.");
            return;
          }

          const success = await uploadBackup(data);
          if (success) {
            alert("‚úì Backup creato con successo!");
          } else {
            alert("‚ùå Errore durante la creazione del backup.");
          }
        }

        // Upload backup to Google Drive
        async function uploadBackup(jsonData) {
          if (!isConnected()) return false;

          await initGoogleAPI();
          const token = getAccessToken();
          gapi.client.setToken({ access_token: token });

          const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
          const fileName = `${BACKUP_PREFIX}${timestamp}.json`;
          const fileContent = JSON.stringify(jsonData, null, 2);

          const boundary = '-------314159265358979323846';
          const delimiter = "\r\n--" + boundary + "\r\n";
          const close_delim = "\r\n--" + boundary + "--";

          const metadata = {
            name: fileName,
            mimeType: 'application/json'
          };

          const multipartRequestBody =
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(metadata) +
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            fileContent +
            close_delim;

          try {
            const response = await gapi.client.request({
              path: 'https://www.googleapis.com/upload/drive/v3/files',
              method: 'POST',
              params: { uploadType: 'multipart' },
              headers: {
                'Content-Type': 'multipart/related; boundary="' + boundary + '"'
              },
              body: multipartRequestBody
            });

            console.log("Backup uploaded:", fileName);

            // Cleanup old backups
            await cleanupOldBackups();

            return true;
          } catch (err) {
            console.error("Upload error:", err);
            if (err.status === 403) {
              alert("‚ö†Ô∏è Sessione scaduta o permessi insufficienti.\n\nPer favore, ricollegati a Google Drive autorizzando l'accesso.");
              disconnect(); // Force cleanup
            }
            return false;
          }
        }

        // List all backups from Google Drive
        async function listBackups() {
          if (!isConnected()) return [];

          await initGoogleAPI();
          const token = getAccessToken();
          gapi.client.setToken({ access_token: token });

          try {
            const response = await gapi.client.drive.files.list({
              q: `name contains '${BACKUP_PREFIX}' and trashed=false`,
              fields: 'files(id, name, createdTime)',
              orderBy: 'createdTime desc',
              pageSize: 50
            });

            return response.result.files || [];
          } catch (err) {
            console.error("List backups error:", err);
            return [];
          }
        }

        // Download backup from Google Drive
        async function downloadBackup(fileId) {
          if (!isConnected()) return null;

          await initGoogleAPI();
          const token = getAccessToken();
          gapi.client.setToken({ access_token: token });

          try {
            const response = await gapi.client.drive.files.get({
              fileId: fileId,
              alt: 'media'
            });

            return response.result;
          } catch (err) {
            console.error("Download backup error:", err);
            return null;
          }
        }

        // Delete a backup
        async function deleteBackup(fileId) {
          if (!isConnected()) return false;

          await initGoogleAPI();
          const token = getAccessToken();
          gapi.client.setToken({ access_token: token });

          try {
            await gapi.client.drive.files.delete({ fileId: fileId });
            return true;
          } catch (err) {
            console.error("Delete backup error:", err);
            return false;
          }
        }

        // Cleanup old backups (keep only last MAX_BACKUPS)
        async function cleanupOldBackups() {
          const backups = await listBackups();
          if (backups.length <= MAX_BACKUPS) return;

          const toDelete = backups.slice(MAX_BACKUPS);
          for (const backup of toDelete) {
            await deleteBackup(backup.id);
            console.log("Deleted old backup:", backup.name);
          }
        }

        // Restore backup with selection UI
        async function restoreBackup() {
          const backups = await listBackups();

          if (backups.length === 0) {
            alert("Nessun backup trovato su Google Drive.");
            return;
          }

          let message = "Seleziona un backup da ripristinare:\n\n";
          backups.forEach((b, idx) => {
            const date = new Date(b.createdTime).toLocaleString('it-IT');
            message += `${idx + 1}. ${date}\n`;
          });
          message += "\nInserisci il numero (o 0 per annullare):";

          const choice = prompt(message);
          const index = parseInt(choice) - 1;

          if (index < 0 || index >= backups.length || isNaN(index)) {
            return;
          }

          const selectedBackup = backups[index];
          const backupData = await downloadBackup(selectedBackup.id);

          if (!backupData) {
            alert("Errore nel download del backup.");
            return;
          }

          if (confirm(`Ripristinare il backup del ${new Date(selectedBackup.createdTime).toLocaleString('it-IT')}?\n\nI dati attuali verranno sostituiti.`)) {
            if (Array.isArray(backupData)) {
              data = backupData.map(x => ({ ...x, id: uid(), created: x.created || Date.now(), updated: Date.now() }));
              persist();
              render();
              alert("‚úì Backup ripristinato con successo!");
            } else {
              alert("Formato backup non valido.");
            }
          }
        }

        // Auto-backup on window close
        function setupAutoBackup() {
          window.addEventListener('beforeunload', (e) => {
            if (!isConnected()) return;

            // Try synchronous backup using sendBeacon as fallback
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });

            // Attempt async upload (may complete if browser allows)
            uploadBackup(data).catch(err => console.error("Auto-backup error:", err));
          });
        }

        // Initialize
        function init() {
          updateUI();
          setupAutoBackup();

          // Initialize buttons
          const connectBtn = $("#gdriveConnect");
          if (connectBtn) {
            connectBtn.addEventListener("click", () => {
              authenticate();
            });

            // Disconnect button
            const disconnectBtn = $("#gdriveDisconnect");
            if (disconnectBtn) {
              disconnectBtn.addEventListener("click", disconnect);
            }

            // Restore backup button
            const restoreBtn = $("#gdriveRestore");
            if (restoreBtn) {
              restoreBtn.addEventListener("click", restoreBackup);
            }

            // Manual backup button
            const manualBackupBtn = $("#gdriveManualBackup");
            if (manualBackupBtn) {
              manualBackupBtn.addEventListener("click", manualBackup);
            }

            // CLIENT_ID validation on input
            const clientIdInput = $("#gdriveClientId");
            if (clientIdInput) {
              clientIdInput.addEventListener("input", (e) => {
                updateClientIdValidation(e.target.value);
              });
            }
          }
        }

        return {
          init,
          isConnected,
          uploadBackup,
          listBackups,
          restoreBackup
        };
      })();

      // Initialize Google Drive Backup
      GoogleDriveBackup.init();

      render();
    })();
  </script>
</body>

</html>